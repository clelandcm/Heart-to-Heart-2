---
title: "HTH2 Weekly Report"
author: "Last Updated"
date: '`r format(Sys.time(), "%B %d, %Y %r %Z")`'
output:
  html_document:
    highlight: tango
    theme: cerulean
    toc: yes
    toc_depth: 5
  word_document:
    toc: yes
    toc_depth: '5'
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, comment=NA, dpi=600, out.width="1536px", height="864px")
```

```{r}
library(redcapAPI)
library(openxlsx)
library(tidyr)
library(dplyr)
library(ggplot2)
library(DiagrammeR)
library(ggthemes)
library(scales)
library(DiagrammeRsvg)
library(svglite)
library(rsvg)
library(png)
library(XML)

tkns <- read.xlsx("c:/chuck/NYU/NoART/REDCap/tkns.xlsx")

rcon <- redcapConnection(url = 'https://openredcap.nyumc.org/apps/redcap/api/', token=tkns[4,3])

hth <- exportRecords(rcon)

# Save big data frame
save(list=c('hth'), file = "c:/chuck/NYU/NoART/Backups/hth.Rdata")
save(list=c('hth'), file = "c:/Dbox/2016 MASTER HTH2 MOST FOLDER/R Data/hth.Rdata")

hth <- hth %>% select(-starts_with("fu"))

# https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html
```

* Approximate number of work days for enrollment remaining: `r floor(as.numeric(as.Date("2019-07-01") - Sys.Date()) * 5/7)`
* Current rate of final eligibility: `r round(sum(hth$scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE) / sum(!is.na(hth$scr1_eligibility)) * 100, 1)`%
* Approximate number of people we need to start initial screening on each work day: `r round(((512 - sum(hth$scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE)) / (sum(hth$scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE) / sum(!is.na(hth$scr1_eligibility)))) / floor(as.numeric(as.Date("2019-07-01") - Sys.Date()) * 5/7), 1)`

# CONSORT Diagram
```{r, fig.height = 8, fig.width = 5, eval = FALSE, results = 'hide'}

# https://rich-iannone.github.io/DiagrammeR/io.html
# https://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html

Screen.1.Total <- paste("Total Screen 1", "<br/>n =", sum(!is.na(hth$scr1_eligibility)), collapse = "")
Screen.1.Pre.Eligible <- paste("Pre-Eligible", "<br/>n =", sum(hth$scr1_eligibility == "Eligible", na.rm = TRUE), collapse = "")
Screen.1.Ineligible <- paste("Ineligble", "<br/>n =", sum(hth$scr1_eligibility == "Ineligible", na.rm = TRUE), collapse = "")
Screen.2A.Total <- paste("Total Screen 2A", "<br/>n =", sum(!is.na(hth$scr2a_prelim_eligibility)), collapse = "")
Screen.2A.Pre.Eligible <- paste("Screen 2A<br/>Pre-eligble", "<br/>n =", sum(hth$scr2a_prelim_eligibility == "Pre-eligible", na.rm = TRUE), collapse = "")
Screen.2A.Ineligible <- paste("Screen 2A<br/>Ineligble", "<br/>n =", sum(hth$scr2a_prelim_eligibility == "Not eligible", na.rm = TRUE), collapse = "")
Screen.2B.Total <- paste("Total Screen 2B", "<br/>n =", sum(!is.na(hth$scr2b_final_eligibility)), collapse = "")
Screen.2B.Eligible <- paste("Screen 2B<br/>Eligble", "<br/>n =", sum(hth$scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE), collapse = "")
Screen.2B.Ineligible <- paste("Screen 2B<br/>Ineligble", "<br/>n =", sum(hth$scr2b_final_eligibility == "No: Not Eligible", na.rm = TRUE), collapse = "")
BL.Total <- paste("Baseline", "<br/>n =", sum(!is.na(hth$bl_date)), collapse = "")
Randomized <- paste("Randomized", "<br/>n =", sum(!is.na(hth$rand_scond)), collapse = "")
Not.Enrolled <- paste("Enrollment<br/>Consent <br/> Not Signed", "<br/>n =", sum(hth$bl_enroll_consent_sign_comp == "No", na.rm = TRUE), collapse = "")
Enrolled <- paste("Enrollment<br/>Consent<br/>Signed", "<br/>n =", sum(hth$bl_enroll_consent_sign_comp == "Yes", na.rm = TRUE), collapse = "")

my.graph <- 
  paste0(  
  'A[', Screen.1.Total, ']-->B[', Screen.1.Ineligible, ']', '\n',
  'A[', Screen.1.Total, ']-->C[', Screen.1.Pre.Eligible, ']', '\n',
  'C[', Screen.1.Pre.Eligible, ']-->D[', Screen.2A.Total, ']', '\n',
  'D[', Screen.2A.Total, ']-->E[', Screen.2A.Pre.Eligible, ']', '\n',
  'D[', Screen.2A.Total, ']-->F[', Screen.2A.Ineligible, ']', '\n',
  'E[', Screen.2A.Pre.Eligible, ']-->G[', Screen.2B.Total, ']', '\n',
  'G[', Screen.2B.Total, ']-->H[', Screen.2B.Eligible, ']', '\n',
  'G[', Screen.2B.Total, ']-->I[', Screen.2B.Ineligible, ']', '\n',
  'H[', Screen.2B.Eligible, ']-->J[', Not.Enrolled, ']', '\n',
  'H[', Screen.2B.Eligible, ']-->K[', Enrolled, ']', '\n',
  'K[', Enrolled, ']-->L[', BL.Total, ']', '\n',
  'L[', BL.Total, ']-->M[', Randomized, ']', '\n')

DiagrammeR::mermaid(
paste0(
"graph TB", "\n",
my.graph, "\n"
),
width = 500,
height = 800)
```

```{r, fig.height = 8, fig.width = 6, eval = FALSE, results = 'hide'}
Screen.1.Total <- paste("Total Screen 1", "\nn =", sum(!is.na(hth$scr1_eligibility)), collapse = "")
Screen.1.Pre.Eligible <- paste("Pre-Eligible", "\nn =", sum(hth$scr1_eligibility == "Eligible", na.rm = TRUE), collapse = "")
Screen.1.Ineligible <- paste("Ineligble", "\nn =", sum(hth$scr1_eligibility == "Ineligible", na.rm = TRUE), collapse = "")
Screen.2A.Total <- paste("Total Screen 2A", "\nn =", sum(!is.na(hth$scr2a_prelim_eligibility)), collapse = "")
Screen.2A.Pre.Eligible <- paste("Screen 2A Pre-eligble", "\nn =", sum(hth$scr2a_prelim_eligibility == "Pre-eligible", na.rm = TRUE), collapse = "")
Screen.2A.Ineligible <- paste("Screen 2A Ineligble", "\nn =", sum(hth$scr2a_prelim_eligibility == "Not eligible", na.rm = TRUE), collapse = "")
Screen.2B.Total <- paste("Total Screen 2B", "\nn =", sum(!is.na(hth$scr2b_final_eligibility)), collapse = "")
Screen.2B.Eligible <- paste("Screen 2B Eligble", "\nn =", sum(hth$scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE), collapse = "")
Screen.2B.Ineligible <- paste("Screen 2B Ineligble", "\nn =", sum(hth$scr2b_final_eligibility == "No: Not Eligible", na.rm = TRUE), collapse = "")
BL.Total <- paste("Baseline", "\nn =", sum(!is.na(hth$bl_date)), collapse = "")
Randomized <- paste("Randomized", "\nn =", sum(!is.na(hth$rand_scond)), collapse = "")
Not.Enrolled <- paste("Enrollment Consent Not Signed", "\nn =", sum(hth$bl_enroll_consent_sign_comp == "No", na.rm = TRUE), collapse = "")
Enrolled <- paste("Enrollment Consent Signed", "\nn =", sum(hth$bl_enroll_consent_sign_comp == "Yes", na.rm = TRUE), collapse = "")

Consort.gv <- grViz("
digraph a_nice_graph {
      
      # node definitions with substituted label text
      node [fontname = Helvetica, fontcolor = red,
            shape = rectangle, color = black]
      node [fontname = Helvetica]
      a [label = '@@1']
      b [label = '@@2']
      c [label = '@@3']
      d [label = '@@4']
      e [label = '@@5']
      f [label = '@@6']
      g [label = '@@7']
      h [label = '@@8']
      i [label = '@@9']
      j [label = '@@10']
      k [label = '@@11']
      l [label = '@@12']
      m [label = '@@13']
      
      # edge definitions with the node IDs
      edge [color = grey, arrowhead = vee]
      a -> {b c}
      b -> {d}
      d -> {e f}
      e -> {g}
      g -> {h i}
      h -> {j k}
      k -> {l}
      l -> {m}
}

[1]: Screen.1.Total
[2]: Screen.1.Pre.Eligible
[3]: Screen.1.Ineligible
[4]: Screen.2A.Total
[5]: Screen.2A.Pre.Eligible
[6]: Screen.2A.Ineligible
[7]: Screen.2B.Total
[8]: Screen.2B.Eligible
[9]: Screen.2B.Ineligible
[10]: Not.Enrolled
[11]: Enrolled
[12]: BL.Total
[13]: Randomized
")

Consort.gv

# export_svg(Consort.gv) %>%
#   charToRaw %>% 
#   rsvg %>% 
#   png::writePNG('c:/Dbox/2016 MASTER HTH2 MOST FOLDER/R Code/All Forms/Consort-Fig.png', dpi = 200)
```

```{r, fig.height = 10, fig.width = 7}
library(graph)
library(Rgraphviz)

cg.A <- paste("Total Screen 1", "\\\nn=", sum(!is.na(hth$scr1_eligibility)), sep = "")
cg.B <- paste("Pre-Eligible", "\\\nn=", sum(hth$scr1_eligibility == "Eligible", na.rm = TRUE), sep = "")
cg.C <- paste("Ineligble", "\\\nn=", sum(hth$scr1_eligibility == "Ineligible", na.rm = TRUE), sep = "")
cg.D <- paste("Total Screen 2A", "\\\nn=", sum(!is.na(hth$scr2a_prelim_eligibility)), sep = "")
cg.E <- paste("Screen 2A\\\nPre-eligble", "\\\nn=", sum(hth$scr2a_prelim_eligibility == "Pre-eligible", na.rm = TRUE), sep = "")
cg.F <- paste("Screen 2A\\\nIneligble", "\\\nn=", sum(hth$scr2a_prelim_eligibility == "Not eligible", na.rm = TRUE), sep = "")
cg.G <- paste("Total Screen 2B", "\\\nn=", sum(!is.na(hth$scr2b_final_eligibility)), sep = "")
cg.H <- paste("Screen 2B\\\nEligble", "\\\nn=", sum(hth$scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE), sep = "")
cg.I <- paste("Screen 2B\\\nIneligble", "\\\nn=", sum(hth$scr2b_final_eligibility == "No: Not Eligible", na.rm = TRUE), sep = "")
cg.J <- paste("Enrollment Consent\\\nNot Signed", "\\\nn=", sum(hth$bl_enroll_consent_sign_comp == "No", na.rm = TRUE), sep = "")
cg.K <- paste("Enrollment Consent\\\nSigned", "\\\nn=", sum(hth$bl_enroll_consent_sign_comp == "Yes", na.rm = TRUE), sep = "")
cg.L <- paste("Baseline", "\\\nn=", sum(!is.na(hth$bl_date)), sep = "")
cg.M <- paste("Randomized", "\\\nn=", sum(!is.na(hth$rand_scond)), sep = "")

consort.graph <- ftM2graphNEL(matrix(c(cg.A,cg.A,cg.B,cg.D,cg.D,cg.E,cg.G,cg.G,cg.H,cg.H,cg.K,cg.L, 
                                       cg.B,cg.C,cg.D,cg.E,cg.F,cg.G,cg.H,cg.I,cg.J,cg.K,cg.L,cg.M), ncol = 2),
                              edgemode="directed")

edges <- buildEdgeList(consort.graph)
nodes <- buildNodeList(consort.graph)

nAttrs <- list()
eAttrs <- list()

Gattrs <- getDefaultAttrs(curAttrs = list(), layoutType = "dot")
Gattrs$graph$margin <- c(0.01,0.01)
Gattrs$graph$size <- c(10,7)
Gattrs$graph$rotate <- 90
Gattrs$node$fontsize <- 14
Gattrs$node$shape <- 'rect'
Gattrs$node$fillcolor <- 'transparent'
Gattrs$node$color <- 'black'
Gattrs$node$fixedsize <- FALSE
Gattrs$edge$weight <- 2
Gattrs$edge$arrowsize <- 0.5

nAttrs$height <- c(0.8, # Total Screen 1
                   0.8, # Screen 1 Pre-Eligible
                   0.8, # Total Screen 2A
                   1.0, # Screen 2A Pre-Eligible
                   0.8, # Total Screen 2B
                   1.0, # Screen 2B Eligible
                   1.0, # Enrollment Consent Signed
                   0.8, # Baseline
                   0.8, # Screen 1 Ineligible
                   1.0, # Screen 2A Ineligible
                   1.0, # Screen 2B Ineligible
                   1.0, # Enrollment Consent Not Signed 
                   0.8) # Randomized

nAttrs$width <- c(2.9,  # Total Screen 1
                  2.0,  # Screen 1 Pre-Eligible
                  2.9,  # Total Screen 2A
                  1.4,  # Screen 2A Pre-Eligible
                  2.9,  # Total Screen 2B
                  1.4,  # Screen 2B Eligible
                  2.9,  # Enrollment Consent Signed
                  2.2,  # Baseline
                  1.6,  # Screen 1 Ineligible
                  1.2,  # Screen 2A Ineligible
                  1.2,  # Screen 2B Ineligible
                  2.9,  # Enrollment Consent Not Signed 
                  2.2)  # Randomized

names(nAttrs$height) <- names(nodes)
names(nAttrs$width) <- names(nodes)

plot(consort.graph, attrs = Gattrs, edgeAttrs = eAttrs, nodeAttrs = nAttrs)
```

# Recruitment Coupons
```{r, echo=FALSE}

RDSCM.Files <- file.info(
list.files(path='C:/Dbox/HTH2 Staff Folders/RDSCM/', 
           pattern = ".xlsm$", full.names = TRUE, recursive = FALSE))

most.recent.RDSCM <- rownames(RDSCM.Files)[which.max(RDSCM.Files$mtime)]

coupons <- read.xlsx(most.recent.RDSCM, sheet = 1, detectDates = TRUE)

distributed <- coupons %>% 
  select(starts_with("Coupon")) %>%
  is.na()
```
* `r sum(!distributed)` coupons distributed
* `r length(na.omit(coupons$Submitted.Coupon))` coupons redeemed

# Screen 1 Pre-Eligible
```{r}
hth %>% 
  filter(redcap_event_name == "screen_1_arm_1" & !is.na(scr1_eligibility)) %>%
  mutate(scr1_eligibility = car::recode(scr1_eligibility, "'Ineligible'='Not eligible';'Eligible'='Pre-eligible'")) %>%
  group_by(scr1_eligibility) %>%
  tally() %>% 
  rename(Count = n) %>% 
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

## Cumulative Number First Stage Screening by Date
```{r}
hth %>% 
  filter(redcap_event_name == "screen_1_arm_1" & !is.na(scr1_eligibility)) %>%
  select(scr1_date, scr1_eligibility) %>%
  arrange(scr1_eligibility, scr1_date) %>%
  mutate(scr1_eligibility = car::recode(scr1_eligibility, "'Eligible'='Pre-eligible'")) %>%
  group_by(scr1_eligibility) %>%
  mutate(Subjects = row_number(scr1_eligibility)) %>%
  ggplot(aes(x = scr1_date, y = Subjects, group = scr1_eligibility, color = scr1_eligibility)) + 
  geom_path() +
  xlab("") + ylab("Number First Stage Screening") +
  scale_color_discrete(guide = guide_legend(title = NULL)) +
  theme_minimal() +
  theme(text = element_text(size=14),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

# Medication Adherence and Viral Load Among Ineligible Participants
## Medication Adherence (0-100)
```{r}
hth %>% 
  filter(redcap_event_name == "screen_1_arm_1" & !is.na(scr1_meds_past6wks_q1)) %>%
  summarize(n = n(),
            Mean = round(mean(scr1_meds_past6wks_q1, na.rm = TRUE)),
            sd = round(sd(scr1_meds_past6wks_q1, na.rm = TRUE)),
            Median = round(median(scr1_meds_past6wks_q1, na.rm = TRUE)),
            IQR = round(IQR(scr1_meds_past6wks_q1, na.rm = TRUE)),
            Min = min(scr1_meds_past6wks_q1, na.rm = TRUE),
            Max = max(scr1_meds_past6wks_q1, na.rm = TRUE)) %>%
  knitr::kable()

hth %>% 
  filter(redcap_event_name == "screen_1_arm_1" & !is.na(scr1_meds_past6wks_q1)) %>%
  ggplot(aes(x = scr1_meds_past6wks_q1)) +
  geom_density(fill="#4169E1", alpha = .33) +
  scale_x_continuous(limits=c(0,100), breaks = seq(0,100,5)) +
  theme_minimal() +
  theme(text = element_text(size=14)) +
  labs(x = "Medication Adherence")
```

## Completion of Viral Load Testing Within Past Six Months
```{r}
hth %>% 
  filter(redcap_event_name == "screen_1_arm_1" & !is.na(scr1_meds_past6wks_q2)) %>%
  group_by(scr1_meds_past6wks_q2) %>%
  tally() %>% 
  rename(Count = n) %>% 
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

## Self-Reported Undetectable Viral Load Among Ineligible with Viral Load Testing Within Past Six Months
```{r}
hth %>% 
  filter(redcap_event_name == "screen_1_arm_1" & !is.na(scr1_meds_past6wks_q3)) %>%
  group_by(scr1_meds_past6wks_q3) %>%
  tally() %>% 
  rename(Count = n) %>% 
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

# Screen 2A Pre-Eligible
```{r}
hth %>% 
  filter(redcap_event_name == "screen_2a_arm_1" & !is.na(scr2a_prelim_eligibility)) %>%
  group_by(scr2a_prelim_eligibility) %>%
  tally() %>% 
  rename(Count = n) %>% 
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

## Cumulative Number Stage 2A Screening by Date
```{r}
hth %>% 
  filter(redcap_event_name == "screen_2a_arm_1") %>%
  select(scr2a_date, scr2a_prelim_eligibility) %>%
  arrange(scr2a_prelim_eligibility, scr2a_date) %>%
  group_by(scr2a_prelim_eligibility) %>%
  mutate(Subjects = row_number(scr2a_prelim_eligibility)) %>%
  ggplot(aes(x = scr2a_date, y = Subjects, group = scr2a_prelim_eligibility, color = scr2a_prelim_eligibility)) + 
  geom_path() +
  xlab("") + ylab("Number Stage 2A Screening") +
  scale_y_continuous(limits = c(0,length(na.omit(hth$scr2a_prelim_eligibility)))) +
  scale_color_discrete(guide = guide_legend(title = NULL)) +
  theme_minimal() +
  theme(text = element_text(size=14),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

# Screen 2B Final Eligibility
```{r}
hth %>% 
  filter(redcap_event_name == "screen_2b_arm_1" & !is.na(scr2b_final_eligibility)) %>%
  group_by(scr2b_final_eligibility) %>%
  tally() %>% 
  rename(Count = n) %>% 
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

## Cumulative Number Final Stage Screening by Date
```{r}
hth$Final.Elg <- hth$scr2b_final_eligibility
  levels(hth$Final.Elg) <- c("Ineligible","Eligible")

  hth %>% 
  filter(redcap_event_name == "screen_2b_arm_1" & !is.na(scr2b_final_eligibility)) %>%
  select(scr2b_sblood_resultdate, scr2b_final_eligibility, scr2b_date, Final.Elg) %>%
  arrange(scr2b_final_eligibility, scr2b_sblood_resultdate) %>%
  group_by(scr2b_final_eligibility) %>%
  mutate(Subjects = row_number(scr2b_final_eligibility)) %>%
  ggplot(aes(x = scr2b_sblood_resultdate, y = Subjects, group = Final.Elg, color = Final.Elg)) +
  geom_path() +
  xlab("") + ylab("Number Final Stage Screening") +
  scale_y_continuous(limits = c(0, length(na.omit(hth$Final.Elg)))) +
  scale_color_discrete(guide = guide_legend(title = NULL)) +
  theme_minimal() +
  theme(text = element_text(size=14),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

# Screening Weekly Totals
## First Stage
```{r}
hth %>%
  filter(!is.na(scr1_date) & !is.na(scr1_eligibility)) %>%
  mutate(Week = cut(scr1_date, breaks = "weeks"),
         Week = format(as.Date(Week), "%B %d, %Y")) %>%
  group_by(Week) %>%
  summarize(`Pre-eligible` = sum(scr1_eligibility == "Eligible"),
            `Ineligible` = sum(scr1_eligibility == "Ineligible"),
            Total = n()) %>%
  arrange(as.Date(Week, format = "%B %d, %Y")) %>%
  mutate(`Cumulative Pre-Eligible` = cumsum(`Pre-eligible`),
         `Cumulative Ineligible` = cumsum(`Ineligible`),
         `Cumulative Total` = cumsum(`Total`),
         `Eligibility Rate` = round(`Cumulative Pre-Eligible` / `Cumulative Total` * 100, 1)) %>%
  knitr::kable()
```

## Stage 2A
```{r}
hth %>%
  filter(!is.na(scr2a_date) & !is.na(scr2a_prelim_eligibility)) %>%
  mutate(Week = cut(scr2a_date, breaks = "weeks"),
         Week = format(as.Date(Week), "%B %d, %Y")) %>%
  group_by(Week) %>%
  summarize(`Pre-eligible` = sum(scr2a_prelim_eligibility == "Pre-eligible"),
            `Ineligible` = sum(scr2a_prelim_eligibility == "Not eligible"),
            Total = n()) %>%
    arrange(as.Date(Week, format = "%B %d, %Y")) %>%
  mutate(`Cumulative Pre-Eligible` = cumsum(`Pre-eligible`),
         `Cumulative Ineligible` = cumsum(`Ineligible`),
         `Cumulative Total` = cumsum(`Total`),
         `Eligibility Rate` = round(`Cumulative Pre-Eligible` / `Cumulative Total` * 100, 1)) %>%
  knitr::kable()
```

## Final Stage
```{r}
hth %>%
  filter(!is.na(scr2b_sblood_resultdate) & !is.na(scr2b_final_eligibility)) %>%
  mutate(Week = cut(scr2b_sblood_resultdate, breaks = "weeks"),
         Week = format(as.Date(Week), "%B %d, %Y")) %>%
  group_by(Week) %>%
  summarize(`Eligible` = sum(scr2b_final_eligibility == "Yes: Eligible"),
            `Ineligible` = sum(scr2b_final_eligibility == "No: Not Eligible"),
            Total = n()) %>%
  arrange(as.Date(Week, format = "%B %d, %Y")) %>%
  mutate(`Cumulative Eligible` = cumsum(`Eligible`),
         `Cumulative Ineligible` = cumsum(`Ineligible`),
         `Cumulative Total` = cumsum(`Total`),
         `Eligibility Rate` = round(`Cumulative Eligible` / `Cumulative Total` * 100, 1)) %>%
  knitr::kable()
```

## Enrolled
```{r}
hth %>%
  filter(!is.na(rand_date)) %>%
  mutate(Week = cut(rand_date, breaks = "weeks"),
         Week = format(as.Date(Week), "%B %d, %Y")) %>%
  group_by(Week) %>%
  tally() %>%
  arrange(as.Date(Week, format = "%B %d, %Y")) %>%
  rename(`Total Enrolled` = n) %>%
  mutate(`Cumulative Total Enrolled` = cumsum(`Total Enrolled`),
         `Cumulative Target` = round(cumsum(rep(5, length(Week)))),
         `Week Number` = 1:length(Week)) %>%
  select(Week, `Week Number`, `Total Enrolled`, `Cumulative Total Enrolled`, `Cumulative Target`) %>%
  knitr::kable()
```

# Screening Activities Completed
```{r}
hth %>% 
  summarize(`First Stage Screening Complete` = sum(!is.na(scr1_eligibility), na.rm = TRUE),
            `First Stage Screening Ineligible` = sum(!is.na(scr1_eligibility) & scr1_eligibility == "Ineligible", na.rm = TRUE),
            `First Stage Screening Pre-Eligible` = sum(!is.na(scr1_eligibility) & scr1_eligibility == "Eligible", na.rm = TRUE),
            `Second Stage Screening Complete` = sum(!is.na(scr2a_prelim_eligibility), na.rm = TRUE),
            `Second Stage Screening Ineligible` = sum(!is.na(scr2a_prelim_eligibility) & scr2a_prelim_eligibility == "Not eligible", na.rm = TRUE),
            `Second Stage Screening Pre-Eligible` = sum(!is.na(scr2a_prelim_eligibility) & scr2a_prelim_eligibility == "Pre-eligible", na.rm = TRUE),
            `Hair Sample Collected` = sum(!is.na(scr2b_sample_hair) & scr2b_sample_hair == "Yes", na.rm = TRUE),
            `Hair Results Available` = sum(!is.na(scr2b_shair_resultdate), na.rm = TRUE),
            `Blood Sample Collected` = sum(!is.na(scr2b_sample_blood) & scr2b_sample_blood == "Yes", na.rm = TRUE),
            `Blood Results Available` = sum(!is.na(scr2b_sblood_resultdate), na.rm = TRUE),
            `Final Stage Screening Complete` = sum(!is.na(scr2b_final_eligibility), na.rm = TRUE),
            `Final Stage Screening Ineligible` = sum(!is.na(scr2b_final_eligibility) & scr2b_final_eligibility == "No: Not Eligible", na.rm = TRUE),
            `Final Stage Screening Eligible` = sum(!is.na(scr2b_final_eligibility) & scr2b_final_eligibility == "Yes: Eligible", na.rm = TRUE)) %>%
  gather(`Screening Activity`, Count) %>%
  knitr::kable()
```

# Randomization
```{r}
hth %>% filter(redcap_event_name == "randomization_arm_2") %>% 
  group_by(rand_scond) %>%
  tally() %>% 
  rename(Condition = rand_scond, Count = n) %>% 
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

## Cumulative Number Assigned to Each Study Condition by Date
```{r, fig.height=10, fig.width=10}
hth %>% 
  filter(redcap_event_name == "randomization_arm_2") %>%
  select(rand_date, rand_scond) %>%
  arrange(rand_scond, rand_date) %>%
  group_by(rand_scond) %>%
  mutate(Subjects = row_number(rand_scond), rand_date = as.Date(rand_date)) %>%
  full_join(expand.grid(rand_date = as.Date("2017-04-01"), rand_scond = levels(hth$rand_scond), Subjects = 0)) %>%
  arrange(rand_scond, rand_date) %>%
  ggplot(aes(x = rand_date, y = Subjects)) +
  geom_point() +
  geom_path() +
  xlab("") + ylab("Number Assigned") +
  scale_y_continuous(limits=c(-0.05, 32), breaks = seq(0, 32, 4)) +
  facet_wrap(~ rand_scond, nrow = 4, ncol = 4) +
  theme_minimal() +
  theme(text = element_text(size=12),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

# Activities Completed
```{r}
hth %>%
  select(unique_id, ends_with("complete"), -unique_id_complete) %>%
  select(-contains("screen")) %>%
  gather(Activity, Completion, -unique_id) %>%
  filter(!is.na(Completion)) %>%
  group_by(Activity) %>%
  summarize(`Complete` = sum(Completion == 2),    
            `Unverified` = sum(Completion == 1),
            `Incomplete` = sum(Completion == 0)) %>%
  knitr::kable()
```

```{r, results = 'hide'}
hth %>% 
  summarize(`Core Session Complete` = sum(!is.na(core_component_form_complete), na.rm = TRUE),
            `MI Session 1 Complete` = sum(!is.na(mi1_date), na.rm = TRUE),
            `MI Session 2 Complete` = sum(!is.na(mi2_date), na.rm = TRUE),
            `MI Session 3 Complete` = sum(!is.na(mi3_date), na.rm = TRUE),
            `MI Session 4 Complete` = sum(!is.na(mi4_date), na.rm = TRUE), 
            `Health Coach Start` = sum(!is.na(hc_date1), na.rm = TRUE),
            `Health Coach Complete` = sum(!is.na(hc_completed), na.rm = TRUE),
            `Pre-Adherence Preparation Start` = sum(!is.na(pap1_date), na.rm = TRUE),
            `Pre-Adherence Preparation Complete` = sum(!is.na(pap_final_session_complete), na.rm = TRUE),
            `Support Group` = sum(!is.na(sg_date), na.rm = TRUE), 
            `Navigation Assessment Form Complete` = sum(!is.na(navigation_assessment_form_complete), na.rm = TRUE),
            `Navigation Action Plans Complete` = sum(!is.na(navigation_action_plans_form_complete), na.rm = TRUE),
            `Navigation Session 1 Complete` = sum(!is.na(navigation_session_1_complete), na.rm = TRUE),
            `Navigation Final Session Complete` = sum(!is.na(navigation_final_session_complete), na.rm = TRUE)) %>%
  gather(`Intervention Activity`, Count) %>%
  knitr::kable()

hth %>%
  select(unique_id, ends_with("complete"), -unique_id_complete) %>%
  gather(Activity, Completion, -unique_id) %>%
  group_by(Activity) %>%
  summarize(`Complete` = sum(Completion == 2),    
            `Unverified` = sum(Completion == 1),
            `Incomplete` = sum(Completion == 0)) %>%
  knitr::kable()
```

```{r, eval = FALSE}
screen_1_interview_complete           
screen_2a_interview_complete                          
screen_2b_interview_complete                   
randomization_form_complete                 
blood_draw_form_complete             
hair_sample_form_complete             
medical_report_form_complete              
participant_basic_info_form_complete 
core_component_form_complete          
mi_session_1_complete                 
mi_session_2_complete                 
mi_session_3_complete                
mi_session_4_complete                
navigation_assessment_form_complete   
navigation_action_plans_form_complete 
navigation_session_1_complete        
provider_question_list_complete       
short_navigation_form_complete        
long_navigation_form_complete         
navigation_final_session_complete    
health_coach_notes_form_complete      
health_coach_session_1_complete       
support_group_form_complete           
pap_session_1_complete               
pap_test_runs_complete                
pap_final_session_complete
```

```{r, results = 'hide'}
hth %>%
  select(unique_id, ends_with("complete"), -unique_id_complete) %>%
  gather(Activity, Completion, -unique_id) %>%
  with(table(Activity, Completion, useNA = "always")) %>%
  knitr::kable()

# 0 = Incomplete
# 1 = Unverified
# 2 = Complete

hth %>% 
  select(contains("_activity"), 
         -ends_with("reason"), 
         -ends_with("act"), 
         -ends_with("other"), 
         -ends_with("spec"), 
         -ends_with("othercomp")) %>%
  gather(Activity, Completion) %>%
  filter(!is.na(Completion)) %>%
  group_by(Activity) %>%
  summarize(`Not at all` = sum(Completion == "Not at all"),    
            `A little` = sum(Completion == "A litle"),
            `Somewhat` = sum(Completion == "Somewhat"),
            `A lot` = sum(Completion == "A lot"),
            `Extensively` = sum(Completion == "Extensively")) %>%
  knitr::kable()
```

```{r echo = FALSE, results = 'hide'}
# Manually Entered Dates

## Screen 1
hth %>%
  filter(redcap_event_name == "screen_1_arm_1") %>%
  select(scr1_date, scr1_before_date)

## Screen 2A
hth %>%
  filter(redcap_event_name == "screen_2a_arm_1") %>%
  select(scr2a_date)

## Screen 2B
hth %>%
  filter(redcap_event_name == "screen_2b_arm_1") %>%
  select(scr2b_date, scr2b_sblood_resultdate, scr2b_shair_resultdate)

## Locator
hth %>%
  filter(redcap_event_name == "screen_2a_arm_1") %>%
  select(loc_date)

## Baseline
hth %>%
  filter(redcap_event_name == "baseline_interview_arm_2") %>%
  select(bl_date)

## Randomization
hth %>% filter(redcap_event_name == "randomization_arm_2") %>%
  select(rand_date)

## Core Session
hth %>% 
  filter(redcap_event_name %in% unique(hth$redcap_event_name)[grep("core_intervention_arm", unique(hth$redcap_event_name))]) %>%
  select(core_date)

## MI Session 1
hth %>% 
  filter(redcap_event_name %in% unique(hth$redcap_event_name)[grep("session_1_arm", unique(hth$redcap_event_name))]) %>%
  select(mi1_date)

## Final Stage Screening Blood Dates
hth %>% 
  filter(redcap_event_name == "screen_2b_arm_1") %>%
  select(scr2b_sample_blood,scr2b_sblood_collectdate,scr2b_sblood_resultdate,
         scr2b_final_eligibility) %>%
  arrange(scr2b_final_eligibility, scr2b_sblood_resultdate)

## Final Stage Screening Hair Dates
hth %>% 
  filter(redcap_event_name == "screen_2b_arm_1") %>%
  select(scr2b_sample_hair,scr2b_shair_collectdate,scr2b_shair_resultdate,
         scr2b_final_eligibility) %>%
  arrange(scr2b_final_eligibility,scr2b_shair_collectdate)
```

```{r, echo = FALSE, results = 'hide'}
# Viral Load of Eligible Participants
hth %>% filter(redcap_event_name == "screen_2b_arm_1") %>% 
  select(unique_id, scr2b_sblood_status_value) %>% 
  na.omit() %>%
  arrange(scr2b_sblood_status_value) 
```

```{r, echo = FALSE}
which.Events <- with(hth, as.data.frame(table(unique_id, redcap_event_name))) %>% 
  filter(Freq != 0) %>%
  rename(Event = redcap_event_name)

Scr1.ID <- hth %>%
  filter(screen_1_interview_complete == 2) %>%
  select(unique_id)

Enrolled <- hth %>% 
  filter(bl_enroll_consent_sign_comp == "Yes") %>% 
               select(unique_id)
```

# Demographics
## Screen 1 Participants (n=`r nrow(Scr1.ID)`)
### Crosstabulation of Gender and Race/Ethnicity
```{r, echo=FALSE}

hth$Multirace <- rowSums(hth[,grep("scr1_race___", names(hth))] == "Checked", na.rm = TRUE)

# a - Native American or Alaskan Native
# b - Asian
# c - Black or African-American
# d - Native Hawaiian or Pacific Islander
# e - White
# f - Other
# g - Don't Know
# h - Refused

hth %>% 
  filter(unique_id %in% Scr1.ID$unique_id & redcap_event_name == "screen_1_arm_1" & screen_1_interview_complete == 2) %>% 
  select(Multirace, scr1_sex, scr1_ethnicity, scr1_race___a:scr1_race___h) %>%
  rename(Gender = scr1_sex) %>%
  group_by(Gender) %>%
  summarize(`American Indian or Alaskan` = sum(scr1_ethnicity == "No" & scr1_race___a == "Checked" & Multirace < 2),
            `Asian or Pacific Islander` = sum(scr1_ethnicity == "No" & (scr1_race___b == "Checked" | scr1_race___d == "Checked" & Multirace < 2)),
            `Black, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___c == "Checked" & Multirace < 2),
            `Hispanic American` = sum(scr1_ethnicity == "Yes"),
            `White, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___e == "Checked" & Multirace < 2),
            `Other or Unknown` = sum(scr1_ethnicity == "No" & 
                                     (Multirace >= 2 |
                                      scr1_race___f == "Checked" | 
                                      scr1_race___g == "Checked" | 
                                      scr1_race___h == "Checked"))) %>%
  gather(`Race-Ethnicity Group`, Count, -Gender) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

### Gender Totals
```{r, echo=FALSE}
hth %>% 
  filter(unique_id %in% Scr1.ID$unique_id & redcap_event_name == "screen_1_arm_1" & screen_1_interview_complete == 2) %>% 
  select(scr1_sex, scr1_ethnicity, scr1_race___a:scr1_race___h) %>%
  rename(Gender = scr1_sex) %>%
  summarize(`Female` = sum(Gender == "Female", na.rm = TRUE),
            `Male` = sum(Gender == "Male", na.rm = TRUE),
            `Refuse to Answer` = sum(Gender == "Refuse to Answer", na.rm = TRUE)) %>%
  gather(`Gender`, Count) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

### Race/Ethnicity Group Totals
```{r}
hth %>% 
  filter(unique_id %in% Scr1.ID$unique_id & redcap_event_name == "screen_1_arm_1" & screen_1_interview_complete == 2) %>% 
  select(Multirace, scr1_ethnicity, scr1_race___a:scr1_race___h) %>%
  summarize(`American Indian or Alaskan` = sum(scr1_ethnicity == "No" & scr1_race___a == "Checked" & Multirace < 2),
            `Asian or Pacific Islander` = sum(scr1_ethnicity == "No" & Multirace < 2 & (scr1_race___b == "Checked" | scr1_race___d == "Checked")),
            `Black, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___c == "Checked" & Multirace < 2),
            `Hispanic American` = sum(scr1_ethnicity == "Yes"),
            `White, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___e == "Checked" & Multirace < 2),
            `Other or Unknown` = sum(scr1_ethnicity == "No" & 
                                     (Multirace >= 2 |
                                      scr1_race___f == "Checked" | 
                                      scr1_race___g == "Checked" | 
                                      scr1_race___h == "Checked"))) %>%
  gather(`Race-Ethnicity Group`, Count) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

### Age
```{r}
hth %>% 
  filter(unique_id %in% Scr1.ID$unique_id & redcap_event_name == "screen_1_arm_1" & screen_1_interview_complete == 2) %>% 
  select(scr1_auto_age) %>%
  summarize(n = n(),
            Mean = round(mean(scr1_auto_age, na.rm = TRUE), 1),
            SD = round(sd(scr1_auto_age, na.rm = TRUE), 1),
            Min = min(scr1_auto_age, na.rm = TRUE),
            `First Quartile` = round(quantile(scr1_auto_age, na.rm = TRUE, probs = .25), 1),
            Median = median(scr1_auto_age, na.rm = TRUE),
            `Third Quartile` = round(quantile(scr1_auto_age, na.rm = TRUE, probs = .75), 1),
            Max = max(scr1_auto_age, na.rm = TRUE)) %>%
  knitr::kable()
```

## Enrolled Participants (n=`r nrow(Enrolled)`)
### Crosstabulation of Gender and Race/Ethnicity
```{r, echo=FALSE}
hth %>% 
  filter(unique_id %in% Enrolled$unique_id & redcap_event_name == "screen_1_arm_1") %>% 
  select(Multirace, scr1_sex, scr1_ethnicity, scr1_race___a:scr1_race___h) %>%
  rename(Gender = scr1_sex) %>%
  group_by(Gender) %>%
  summarize(`American Indian or Alaskan` = sum(scr1_ethnicity == "No" & scr1_race___a == "Checked" & Multirace < 2),
            `Asian or Pacific Islander` = sum(scr1_ethnicity == "No" & (scr1_race___b == "Checked" | scr1_race___d == "Checked" & Multirace < 2)),
            `Black, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___c == "Checked" & Multirace < 2),
            `Hispanic American` = sum(scr1_ethnicity == "Yes"),
            `White, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___e == "Checked" & Multirace < 2),
            `Other or Unknown` = sum(scr1_ethnicity == "No" & 
                                     (Multirace >= 2 |
                                      scr1_race___f == "Checked" | 
                                      scr1_race___g == "Checked" | 
                                      scr1_race___h == "Checked"))) %>%
  gather(`Race-Ethnicity Group`, Count, -Gender) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

### Gender Totals
```{r, echo=FALSE}
hth %>% 
  filter(unique_id %in% Enrolled$unique_id & redcap_event_name == "screen_1_arm_1") %>% 
  select(scr1_sex, scr1_ethnicity, scr1_race___a:scr1_race___h) %>%
  rename(Gender = scr1_sex) %>%
  summarize(`Female` = sum(Gender == "Female", na.rm = TRUE),
            `Male` = sum(Gender == "Male", na.rm = TRUE),
            `Refuse to Answer` = sum(Gender == "Refuse to Answer", na.rm = TRUE)) %>%
  gather(`Gender`, Count) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

### Race/Ethnicity Group Totals
```{r}
hth %>% 
  filter(unique_id %in% Enrolled$unique_id & redcap_event_name == "screen_1_arm_1") %>% 
  select(Multirace, scr1_ethnicity, scr1_race___a:scr1_race___h) %>%
  summarize(`American Indian or Alaskan` = sum(scr1_ethnicity == "No" & scr1_race___a == "Checked" & Multirace < 2),
            `Asian or Pacific Islander` = sum(scr1_ethnicity == "No" & Multirace < 2 & (scr1_race___b == "Checked" | scr1_race___d == "Checked")),
            `Black, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___c == "Checked" & Multirace < 2),
            `Hispanic American` = sum(scr1_ethnicity == "Yes"),
            `White, Not of Hispanic American Origin` = sum(scr1_ethnicity == "No" & scr1_race___e == "Checked" & Multirace < 2),
            `Other or Unknown` = sum(scr1_ethnicity == "No" & 
                                     (Multirace >= 2 |
                                      scr1_race___f == "Checked" | 
                                      scr1_race___g == "Checked" | 
                                      scr1_race___h == "Checked"))) %>%
  gather(`Race-Ethnicity Group`, Count) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  knitr::kable()
```

### Age
```{r}
hth %>% 
  filter(unique_id %in% Enrolled$unique_id & redcap_event_name == "screen_1_arm_1") %>% 
  select(scr1_auto_age) %>%
  summarize(n = n(),
            Mean = round(mean(scr1_auto_age, na.rm = TRUE), 1),
            SD = round(sd(scr1_auto_age, na.rm = TRUE), 1),
            Min = min(scr1_auto_age, na.rm = TRUE),
            `First Quartile` = round(quantile(scr1_auto_age, na.rm = TRUE, probs = .25), 1),
            Median = median(scr1_auto_age, na.rm = TRUE),
            `Third Quartile` = round(quantile(scr1_auto_age, na.rm = TRUE, probs = .75), 1),
            Max = max(scr1_auto_age, na.rm = TRUE)) %>%
  knitr::kable()
```

```{r, eval = FALSE}
library(RCurl)
library(XML)

H2H.backup <- postForm(
    uri='https://openredcap.nyumc.org/apps/redcap/api/',
    token=tkns[4,3],
    content='project_xml',
    format='json',
    returnMetadataOnly='false',
    exportSurveyFields='false',
    exportDataAccessGroups='false',
    returnFormat='json')

H2H.data.dictionary <- postForm(
    uri='https://openredcap.nyumc.org/apps/redcap/api/',
    token=tkns[4,3],
    content='metadata',
    format='xml',
    returnFormat='json'
)

ddict.H2H <- xmlToDataFrame(H2H.data.dictionary)

save(list=c('H2H.backup','H2H.data.dictionary'), 
     file = paste("c:/chuck/NYU/NoART/Backups/H2H-Backup-", Sys.Date(), ".RData", sep = ""))

hth %>% 
  filter(!is.na(rand_scond)) %>% 
  select(unique_id, rand_scond, rand_date) %>% 
  left_join(hth %>% select(unique_id, rand_condition)) %>%
  filter(!is.na(rand_condition)) %>%
  arrange(rand_condition, rand_date) %>%
  select(-unique_id)

atab <- read.csv("c:/chuck/NYU/noart/Randomization/atab-production-15February2017.csv")
atab$Condition <- factor(atab$rand_scond - 2,
                         labels = c('1. Bear', 
                                    '2. Cat', 
                                    '3. Dog',
                                    '4. Eagle',
                                    '5. Fish',
                                    '6. Goat',
                                    '7. Horse',
                                    '8. Lion',
                                    '9. Moth',
                                    '10. Owl',
                                    '11. Panda',
                                    '12. Rabbit',
                                    '13. Snake',
                                    '14. Tiger',
                                    '15. Whale',
                                    '16. Yak'))
```

```{r, echo = FALSE, results='hide'}
# Selected for Qualitative Interviews
load("C:/Dbox/2016 MASTER HTH2 MOST FOLDER/R Code/Qualitative-Random-Selection-14June2017.RData", .GlobalEnv)

hth %>% 
  filter(redcap_event_name == "randomization_arm_2") %>%
  select(unique_id, rand_timestamp_auto, rand_scond) %>%
  arrange(rand_scond, rand_timestamp_auto) %>%
  group_by(rand_scond) %>%
  mutate(ENRLORDER = row_number(rand_scond)) %>%
  ungroup() %>%
  full_join(Qual_Selected %>% rename(rand_scond = Condition)) %>%
  mutate(Qual_Included = ifelse(ENRLORDER == First | 
                                ENRLORDER == Second | 
                                ENRLORDER == Third, "Yes", "No")) %>%
  filter(!is.na(unique_id) & Qual_Included == "Yes") %>%
  select(unique_id, rand_timestamp_auto, rand_scond, Qual_Included) %>%
  as.data.frame() %>%
  knitr::kable()
```

# Eligibility Rate Over Time
## Overall
```{r}
 hth %>%
  filter(!is.na(scr1_date) & !is.na(scr1_eligibility)) %>%
  mutate(Day = cut(scr1_date, breaks = "days"),
         Day.Char = format(as.Date(Day), "%B %d, %Y"),
         Date = as.Date(Day)) %>%
  group_by(Date) %>%
  summarize(`Started Screening` = n()) %>%
  full_join(
    hth %>%
      filter(!is.na(scr2b_sblood_resultdate) & !is.na(scr2b_final_eligibility)) %>%
      mutate(Day = cut(scr2b_sblood_resultdate, breaks = "days"),
             Day.Char = format(as.Date(Day), "%B %d, %Y"),
             Date = as.Date(Day)) %>%
      group_by(Date) %>%
      summarize(Eligible = sum(scr2b_final_eligibility == "Yes: Eligible"))
  ) %>%
  arrange(Date) %>%
  mutate(`Started Screening` = ifelse(is.na(`Started Screening`), 0, `Started Screening`),
         Eligible = ifelse(is.na(Eligible), 0, Eligible),
         `Started Screening Cumulative` = cumsum(`Started Screening`),
         `Eligible Cumulative` = cumsum(Eligible),
         `Eligibility Rate` = round(`Eligible Cumulative` / `Started Screening Cumulative` * 100, 1),
         `Metro Ad` = ifelse(Date > "2017-08-07", "New", "Old")) %>%
  filter(Date > "2017-04-01") %>%
  ggplot(aes(x = Date, y = `Eligibility Rate`)) + 
  geom_point() +
  geom_smooth(se=FALSE) +
  scale_y_continuous(limits = c(2,10), breaks = seq(2,10,0.5)) +
  theme_minimal() +
  theme(text = element_text(size=14))
```

## By Recruitment Approach
```{r}
Recruiting_Eligible <- inner_join(subset(hth, !is.na(scr1_date) & !is.na(scr1_eligibility) & !is.na(scr1_recruited), select = c(unique_id, scr1_date, scr1_recruited)),
                                  subset(hth, !is.na(scr2b_sblood_resultdate) & !is.na(scr2b_final_eligibility), select = c(unique_id, scr2b_sblood_resultdate, scr2b_final_eligibility))) %>%
  mutate(Day = cut(scr2b_sblood_resultdate, breaks = "days"),
         Day.Char = format(as.Date(Day), "%B %d, %Y"),
         Date = as.Date(Day)) %>%
  group_by(scr1_recruited, Date) %>%
  summarize(Eligible = sum(scr2b_final_eligibility == "Yes: Eligible"))

Recruiting_Screened <- hth %>%
  filter(!is.na(scr1_date) & !is.na(scr1_eligibility) & !is.na(scr1_recruited)) %>%
  mutate(Day = cut(scr1_date, breaks = "days"),
         Day.Char = format(as.Date(Day), "%B %d, %Y"),
         Date = as.Date(Day)) %>%
  group_by(scr1_recruited, Date) %>%
  summarize(`Started Screening` = n())

Recruiting_Screened %>% 
  left_join(Recruiting_Eligible) %>%
  arrange(scr1_recruited, Date) %>%
  mutate(`Started Screening` = ifelse(is.na(`Started Screening`), 0, `Started Screening`),
         Eligible = ifelse(is.na(Eligible), 0, Eligible),
         `Started Screening Cumulative` = cumsum(`Started Screening`),
         `Eligible Cumulative` = cumsum(Eligible),
         `Eligibility Rate` = round(`Eligible Cumulative` / `Started Screening Cumulative` * 100, 1)) %>%
  ggplot(aes(x = Date, y = `Eligibility Rate`)) + 
  geom_point() +
  geom_smooth(se=FALSE) +
  facet_wrap(~ scr1_recruited) +
  labs(x = "") +
  theme(text = element_text(size=14), axis.text.x = element_text(angle = 35, hjust = 1))
```

```{r, eval=FALSE}
hth %>% 
  filter(nchar(unique_id) != 11) %>% 
  select(unique_id, redcap_event_name)

#        unique_id redcap_event_name
# 1 212-677-7001 *    screen_1_arm_1
# 2   BLNM090668F2    screen_1_arm_1
# 3   BONL052574M2    screen_1_arm_1
# 4   BONL052574M2   screen_2a_arm_1
# 5   BONL052574M2   screen_2b_arm_1
# 6     MCBE022258    screen_1_arm_1
# 7   MUAR012055M2    screen_1_arm_1
# 8   RICR050979M2    screen_1_arm_1
```

```{r}
all_UID <- data.frame(UID = unique(c(hth$unique_id, coupons$Unique.ID)))

all_UID <- all_UID %>% mutate(UID = as.character(UID),
                              RDSCM = UID %in% coupons$Unique.ID, 
                              REDCap = UID %in% hth$unique_id,
                              UID.Length = nchar(UID))

all_UID <- all_UID %>% left_join(coupons %>% 
                                   select(Unique.ID, Date), by = c("UID" = "Unique.ID")) %>% 
  rename("RDSCM_Date" = "Date") %>%
  left_join(hth %>% filter(redcap_event_name == "screen_1_arm_1") %>% select(unique_id, scr1_date),
            by = c("UID" = "unique_id"))

all_UID %>% filter(!RDSCM | !REDCap) %>%
  write.csv(file = "c:/chuck/NYU/NoArt/ID-Issues-1September2017.csv", quote = FALSE, row.names = FALSE)
```
